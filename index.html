<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="行動記帳">
  <meta name="apple-mobile-web-app-title" content="行動記帳">
  <meta name="theme-color" content="#000000">
  <link rel="icon" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/2953/2953423.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2953/2953423.png">
  <link rel="manifest" href="manifest.json">

  <title>行動分析記帳本</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { 
      --bg:#000000; --card:#161b22; --text:#ffffff; --muted:#8b949e; 
      --line:#30363d; --accent:#58a6ff; --danger:#f85149; --nav-height: 65px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin:0; font-family: -apple-system, system-ui, sans-serif; 
      background:var(--bg); color:var(--text); padding-bottom: calc(var(--nav-height) + 20px);
    }
    .container { padding: 12px; max-width: 600px; margin: 0 auto; }
    .header { padding: 20px 16px 5px; font-size: 18px; font-weight: 800; color: var(--accent); }

    /* 統計區塊 */
    .stat-card { background: linear-gradient(145deg, #1c2128, #161b22); border: 1px solid var(--line); border-radius: 20px; padding: 18px; margin-bottom: 12px; }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-main-num { font-size: 28px; font-weight: 900; color: var(--text); margin: 5px 0; }
    .top-rank-item { display: flex; justify-content: space-between; font-size: 13px; margin-top: 8px; padding: 4px 0; border-bottom: 1px solid #21262d; }
    .top-rank-item:last-child { border: none; }

    /* 比例條 */
    .ratio-bar-container { margin-bottom: 12px; }
    .ratio-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .ratio-bg { background: #21262d; height: 6px; border-radius: 3px; overflow: hidden; }
    .ratio-fill { background: var(--accent); height: 100%; transition: width 0.3s ease; }

    .page { display: none; animation: fadeIn 0.2s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .card { background: var(--card); border: 1px solid var(--line); border-radius: 20px; padding: 16px; margin-bottom: 12px; }
    label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--line); background: #0d1117; color: #fff; font-size: 16px; }
    
    /* 計算機 */
    .calc-box { background: #000; border-radius: 16px; padding: 10px; border: 1px solid var(--line); }
    .calc-display { text-align: right; padding: 8px; margin-bottom: 8px; border-bottom: 1px solid var(--line); }
    #calcExpr { font-size: 13px; color: var(--muted); min-height: 18px; font-family: monospace; }
    #calcResult { font-size: 28px; font-weight: 900; margin-top: 2px; }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .key { padding: 16px 0; border-radius: 12px; border: none; background: #21262d; color: #fff; font-size: 18px; font-weight: 600; cursor: pointer; }
    .key.op { color: var(--accent); }
    .key.danger { color: var(--danger); }
    .key.confirm { background: var(--accent); color: #000; grid-column: span 2; }

    .pill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .pill { padding: 10px 4px; border-radius: 10px; border: 1px solid var(--line); background: #0d1117; color: var(--text); font-size: 12px; cursor: pointer; text-align: center; white-space: nowrap; overflow: hidden; }
    .pill.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: rgba(22, 27, 34, 0.96); backdrop-filter: blur(12px); border-top: 1px solid var(--line); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--muted); font-size: 10px; gap: 4px; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--accent); }
    .btn-save { width: 100%; padding: 18px; border-radius: 16px; border: none; background: var(--accent); color: #000; font-size: 18px; font-weight: 800; cursor: pointer; margin-top: 15px; }

    .list-item { background: var(--card); border-bottom: 1px solid var(--line); padding: 14px; display: flex; justify-content: space-between; align-items: center; }
    
    /* 設定頁面管理樣式 */
    .set-item { display: flex; align-items: center; background: #0d1117; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--line); }
    .set-item.dragging { opacity: 0.4; border: 1px dashed var(--accent); }
    .drag-handle { cursor: grab; padding-right: 15px; color: var(--muted); font-size: 20px; user-select: none; }
  </style>
</head>
<body>

  <div class="header">行動分析記帳本</div>

  <div class="container">
    <div id="page-add" class="page active">
      <div class="stat-card">
        <div class="stat-label">本月總支出</div>
        <div class="stat-main-num dashTotal">$ 0</div>
        <div id="dashTopThree"></div>
      </div>

      <div class="card">
        <label>日期</label>
        <input id="dateInput" type="date" style="margin-bottom: 15px;" />
        <label>分類</label>
        <div id="categoryPills" class="pill-grid"></div>
        <label>付款方式</label>
        <div id="paymentPills" class="pill-grid"></div>
        <label>備註</label>
        <textarea id="noteInput" rows="2" placeholder="備註內容..."></textarea>
      </div>

      <div class="card">
        <label>金額</label>
        <input id="amountInput" type="text" readonly placeholder="0" style="color:var(--accent); font-weight:800; text-align:right; margin-bottom: 15px;" />
        <div class="calc-box">
          <div class="calc-display"><div id="calcExpr"></div><div id="calcResult">0</div></div>
          <div class="calc-grid" id="calcGrid"></div>
        </div>
        <button class="btn-save" id="saveBtn">儲存紀錄</button>
      </div>
    </div>

    <div id="page-list" class="page">
      <div class="stat-card">
        <div class="stat-label">本月總支出明細</div>
        <div class="stat-main-num dashTotal">$ 0</div>
        <div id="ratioBars" style="margin-top: 15px; border-top: 1px solid #30363d; padding-top: 15px;"></div>
      </div>
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <input id="monthPicker" type="month" style="width: auto; padding: 8px;" />
        <button onclick="exportToExcel()" style="color:var(--accent); background:none; border:none; font-weight:bold;">匯出 EXCEL</button>
      </div>
      <div id="historyList"></div>
    </div>

    <div id="page-settings" class="page">
      <div class="card">
        <h2>分類管理 (拖曳 ≡ 排序)</h2>
        <div style="display:flex; gap:8px; margin-bottom:12px;">
          <input id="newCatInput" type="text" placeholder="新分類名稱" />
          <button onclick="addItem('categories')" style="background:var(--accent); border:none; padding:0 15px; border-radius:12px; color:#000; font-weight:bold;">＋</button>
        </div>
        <div id="catSetList"></div>
      </div>
      <div class="card">
        <h2>付款方式 (拖曳 ≡ 排序)</h2>
        <div style="display:flex; gap:8px; margin-bottom:12px;">
          <input id="newPayInput" type="text" placeholder="新付款名稱" />
          <button onclick="addItem('payments')" style="background:var(--accent); border:none; padding:0 15px; border-radius:12px; color:#000; font-weight:bold;">＋</button>
        </div>
        <div id="paySetList"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-page="add"><span>＋</span><div>記帳</div></div>
    <div class="nav-item" data-page="list"><span>☰</span><div>明細</div></div>
    <div class="nav-item" data-page="settings"><span>⚙</span><div>設定</div></div>
  </div>

  <script>
    const LS_KEY = "mobile_expense_v1";
    let db = JSON.parse(localStorage.getItem(LS_KEY)) || {
      transactions: [],
      categories: ["早餐","午餐","晚餐","交通","購物","醫療","其他"],
      payments: ["現金","信用卡","行動支付"]
    };

    let selectedCat = db.categories[0];
    let selectedPay = db.payments[0];
    let calcExpr = "";

    function saveDB() { 
      localStorage.setItem(LS_KEY, JSON.stringify(db)); 
      updateStats(); 
    }

    function updateStats() {
      const ym = document.getElementById("monthPicker")?.value || new Date().toISOString().slice(0, 7);
      const monthly = db.transactions.filter(t => t.date.startsWith(ym));
      const total = monthly.reduce((s, t) => s + t.amount, 0);

      document.querySelectorAll(".dashTotal").forEach(el => el.textContent = `$ ${total.toLocaleString()}`);

      const catStats = {};
      monthly.forEach(t => { catStats[t.category] = (catStats[t.category] || 0) + t.amount; });
      const sorted = Object.entries(catStats).sort((a,b) => b[1] - a[1]);

      document.getElementById("dashTopThree").innerHTML = sorted.slice(0, 3).map(([c, a], i) => `
        <div class="top-rank-item"><span style="color:var(--muted)">${i+1}. ${c}</span><span style="color:var(--accent); font-weight:600">$${a.toLocaleString()}</span></div>
      `).join('') || '<div style="font-size:12px; color:var(--muted); margin-top:10px;">目前無數據</div>';

      document.getElementById("ratioBars").innerHTML = sorted.map(([c, a]) => {
        const r = total > 0 ? ((a/total)*100).toFixed(1) : 0;
        return `<div class="ratio-bar-container"><div class="ratio-header"><span>${c}</span><span>$${a.toLocaleString()} (${r}%)</span></div><div class="ratio-bg"><div class="ratio-fill" style="width:${r}%"></div></div></div>`;
      }).join('') || '<div style="font-size:12px; color:var(--muted); text-align:center;">目前無分析數據</div>';
    }

    function setupNav() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.onclick = () => {
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          const p = item.dataset.page;
          document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
          document.getElementById('page-' + p).classList.add('active');
          if(p === 'list') renderHistory();
          if(p === 'settings') renderSettings();
        };
      });
    }

    function renderPills() {
      document.getElementById("categoryPills").innerHTML = db.categories.map(c => `<div class="pill ${c===selectedCat?'active':''}" onclick="selectedCat='${c}';renderPills()">${c}</div>`).join('');
      document.getElementById("paymentPills").innerHTML = db.payments.map(p => `<div class="pill ${p===selectedPay?'active':''}" onclick="selectedPay='${p}';renderPills()">${p}</div>`).join('');
    }

    function setupCalc() {
      const keys = ['C','BK','(',')','7','8','9','/','4','5','6','*','1','2','3','-','0','.','+','='];
      document.getElementById("calcGrid").innerHTML = keys.map(k => {
        let cls = "key"; if(['C','BK'].includes(k)) cls += " danger"; if(['/','*','-','+','(',')'].includes(k)) cls += " op"; if(k === '=') cls += " confirm";
        return `<button class="${cls}" data-key="${k}">${k==='BK'?'⌫':k==='*'?'×':k==='/'?'÷':k}</button>`;
      }).join('');
      document.querySelectorAll('.key').forEach(btn => {
        btn.onclick = () => {
          const k = btn.dataset.key;
          if(k === 'C') calcExpr = "";
          else if(k === 'BK') calcExpr = calcExpr.slice(0, -1);
          else if(k === '=') { try { calcExpr = String(eval(calcExpr.replace(/×/g, '*').replace(/÷/g, '/'))); } catch { alert("算式錯誤"); } }
          else { calcExpr += k; }
          document.getElementById("calcExpr").textContent = calcExpr;
          try {
            const res = eval(calcExpr.replace(/×/g, '*').replace(/÷/g, '/')) || 0;
            const f = Math.round(res * 100) / 100;
            document.getElementById("calcResult").textContent = f.toLocaleString();
            document.getElementById("amountInput").value = f;
          } catch { document.getElementById("calcResult").textContent = "—"; }
        };
      });
    }

    document.getElementById("saveBtn").onclick = () => {
      const amt = parseFloat(document.getElementById("amountInput").value);
      if(!amt || amt <= 0) return alert("請輸入金額");
      db.transactions.push({ id: Date.now(), date: document.getElementById("dateInput").value, category: selectedCat, payment: selectedPay, amount: amt, note: document.getElementById("noteInput").value });
      saveDB();
      const b = document.getElementById("saveBtn"); b.textContent = "✓ 已儲存"; b.style.background = "#3fb950";
      setTimeout(() => { b.textContent = "儲存紀錄"; b.style.background = "var(--accent)"; }, 1000);
      calcExpr = ""; document.getElementById("calcExpr").textContent = ""; document.getElementById("calcResult").textContent = "0"; document.getElementById("amountInput").value = "";
    };

    function renderHistory() {
      const ym = document.getElementById("monthPicker").value;
      const filtered = db.transactions.filter(t => t.date.startsWith(ym)).sort((a,b)=>b.date.localeCompare(a.date));
      document.getElementById("historyList").innerHTML = filtered.length ? filtered.map(t => `
        <div class="list-item"><div style="flex:1"><div style="font-size:11px; color:var(--muted)">${t.date} · ${t.payment}</div><div style="font-size:15px; font-weight:600">${t.category}</div><div style="font-size:12px; color:var(--muted)">${t.note||''}</div></div><div style="text-align:right"><div style="font-size:18px; font-weight:800; color:var(--accent)">$${t.amount.toLocaleString()}</div><button onclick="deleteTx(${t.id})" style="color:var(--danger); background:none; border:none; font-size:12px; font-weight:600; margin-top:5px">刪除</button></div></div>
      `).join('') : '<div style="text-align:center; padding:50px; color:var(--muted)">本月尚無紀錄</div>';
    }

    window.deleteTx = (id) => { if(confirm("確定刪除？")) { db.transactions = db.transactions.filter(t => t.id !== id); saveDB(); renderHistory(); } };

    // 設定管理與排序
    function renderSettings() {
      renderDragList('catSetList', 'categories');
      renderDragList('paySetList', 'payments');
    }

    function renderDragList(containerId, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = db[type].map((item, idx) => `
        <div class="set-item" draggable="true" data-index="${idx}" data-type="${type}">
          <div class="drag-handle">≡</div>
          <span style="flex:1; font-weight:500;">${item}</span>
          <button onclick="delItem('${type}', ${idx})" style="color:var(--danger); background:none; border:none; font-size:18px;">✕</button>
        </div>
      `).join('');

      container.querySelectorAll('.set-item').forEach(el => {
        el.ondragstart = (e) => { e.dataTransfer.setData('idx', el.dataset.index); el.classList.add('dragging'); };
        el.ondragend = () => el.classList.remove('dragging');
        el.ondragover = (e) => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging');
          if (dragging.dataset.type !== type) return;
          const afterElement = getDragAfterElement(container, e.clientY);
          if (afterElement == null) container.appendChild(dragging);
          else container.insertBefore(dragging, afterElement);
        };
        el.ondrop = () => {
          const newList = Array.from(container.querySelectorAll('span')).map(s => s.textContent);
          db[type] = newList;
          saveDB(); renderPills();
        };
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.set-item:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
        else return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    window.addItem = (type) => {
      const input = document.getElementById(type === 'categories' ? 'newCatInput' : 'newPayInput');
      if(input.value.trim()) { db[type].push(input.value.trim()); input.value = ""; saveDB(); renderSettings(); renderPills(); }
    };
    window.delItem = (type, idx) => { if(db[type].length > 1) { db[type].splice(idx, 1); saveDB(); renderSettings(); renderPills(); } };

    function init() {
      document.getElementById("dateInput").value = new Date().toISOString().split('T')[0];
      const m = document.getElementById("monthPicker"); m.value = new Date().toISOString().slice(0, 7);
      m.onchange = () => { renderHistory(); updateStats(); };
      renderPills(); setupCalc(); setupNav(); updateStats();
    }
    
    window.exportToExcel = () => {
      const ym = document.getElementById("monthPicker").value;
      const filtered = db.transactions.filter(t => t.date.startsWith(ym));
      XLSX.writeFile(XLSX.utils.book_new().appendChild(XLSX.utils.json_to_sheet(filtered), "History"), `記帳_${ym}.xlsx`);
    };

    init();
  </script>
</body>
</html>
