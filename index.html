<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="行動記帳">
  <meta name="apple-mobile-web-app-title" content="行動記帳">
  <meta name="theme-color" content="#000000">
  <link rel="icon" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/2953/2953423.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2953/2953423.png">
  <link rel="manifest" href="manifest.json">
  <title>行動分析記帳本</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#000000; --card:#161b22; --text:#ffffff; --muted:#8b949e; --line:#30363d; --accent:#58a6ff; --danger:#f85149; --nav-height: 65px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin:0; font-family: -apple-system, system-ui, sans-serif; background:var(--bg); color:var(--text); padding-bottom: calc(var(--nav-height) + 20px); }
    .container { padding: 12px; max-width: 600px; margin: 0 auto; }
    .header { padding: 20px 16px 5px; font-size: 20px; font-weight: 800; color: var(--accent); }
    
    /* 統計卡片樣式 */
    .stat-card { background: linear-gradient(145deg, #1c2128, #161b22); border: 1px solid var(--line); border-radius: 20px; padding: 18px; margin-bottom: 12px; }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-main-num { font-size: 28px; font-weight: 900; color: var(--text); margin: 5px 0; }
    
    /* 明細頁專用：每日標題與統計 */
    .day-group-header { 
      display: flex; justify-content: space-between; align-items: flex-end;
      padding: 15px 10px 8px; border-bottom: 1px solid var(--line); margin-top: 10px;
    }
    .day-date { font-size: 14px; font-weight: 800; color: var(--accent); }
    .day-total { font-size: 13px; font-weight: 600; color: #aff5b4; }

    .page { display: none; animation: fadeIn 0.2s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 20px; padding: 16px; margin-bottom: 12px; }
    label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--line); background: #0d1117; color: #fff; font-size: 16px; }
    
    /* 計算機樣式 */
    .calc-box { background: #000; border-radius: 16px; padding: 10px; border: 1px solid var(--line); }
    .calc-display { text-align: right; padding: 8px; margin-bottom: 8px; border-bottom: 1px solid var(--line); }
    #calcExpr { font-size: 13px; color: var(--muted); min-height: 18px; font-family: monospace; }
    #calcResult { font-size: 28px; font-weight: 900; margin-top: 2px; }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .key { padding: 16px 0; border-radius: 12px; border: none; background: #21262d; color: #fff; font-size: 18px; font-weight: 600; cursor: pointer; }
    .key.op { color: var(--accent); }
    .key.danger { color: var(--danger); }
    .key.confirm { background: var(--accent); color: #000; grid-column: span 2; }

    .pill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .pill { padding: 10px 4px; border-radius: 10px; border: 1px solid var(--line); background: #0d1117; color: var(--text); font-size: 12px; cursor: pointer; text-align: center; }
    .pill.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: rgba(22, 27, 34, 0.96); backdrop-filter: blur(12px); border-top: 1px solid var(--line); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--muted); text-decoration: none; font-size: 11px; gap: 4px; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 20px; }

    .btn-save { width: 100%; padding: 18px; border-radius: 16px; border: none; background: var(--accent); color: #000; font-size: 18px; font-weight: 800; cursor: pointer; margin-top: 15px; }
    .list-item { background: var(--card); border-bottom: 1px solid var(--line); padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; }
    
    .set-item { display: flex; align-items: center; background: #0d1117; padding: 14px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--line); }
  </style>
</head>
<body>

  <div class="header">行動分析記帳本</div>

  <div class="container">
    <div id="page-add" class="page active">
      <div class="stat-card">
        <div class="stat-label">本月總支出</div>
        <div class="stat-main-num dashTotal">$ 0</div>
        <div id="dashTopThree"></div>
      </div>
      <div class="card">
        <label>日期</label><input id="dateInput" type="date" style="margin-bottom:15px;" />
        <label>分類</label><div id="categoryPills" class="pill-grid"></div>
        <label>付款方式</label><div id="paymentPills" class="pill-grid"></div>
        <label>備註</label><textarea id="noteInput" rows="2" placeholder="備註內容..."></textarea>
      </div>
      <div class="card">
        <label>金額確認</label><input id="amountInput" type="text" readonly placeholder="0" style="color:var(--accent); font-weight:800; text-align:right; margin-bottom:15px;" />
        <div class="calc-box"><div class="calc-display"><div id="calcExpr"></div><div id="calcResult">0</div></div><div class="calc-grid" id="calcGrid"></div></div>
        <button class="btn-save" id="saveBtn">儲存紀錄</button>
      </div>
    </div>

    <div id="page-list" class="page">
      <div class="stat-card">
        <div class="stat-label">本月總支出明細</div>
        <div class="stat-main-num dashTotal">$ 0</div>
      </div>
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <input id="monthPicker" type="month" style="width:auto; padding:8px;" />
        <button onclick="exportToExcel()" style="color:var(--accent); background:none; border:none; font-weight:bold;">匯出 EXCEL</button>
      </div>
      <div id="historyList"></div>
    </div>

    <div id="page-settings" class="page">
      <div class="card">
        <h2>分類管理</h2>
        <div id="catSetList"></div>
      </div>
      <div class="card">
        <h2>付款方式</h2>
        <div id="paySetList"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-page="add"><div class="nav-icon">＋</div><div>記帳</div></div>
    <div class="nav-item" data-page="list"><div class="nav-icon">☰</div><div>明細</div></div>
    <div class="nav-item" data-page="settings"><div class="nav-icon">⚙</div><div>設定</div></div>
  </div>

  <script>
    const LS_KEY = "mobile_expense_v1";
    let db = JSON.parse(localStorage.getItem(LS_KEY)) || {
      transactions: [],
      categories: ["早餐","午餐","晚餐","交通","購物","醫療","其他"],
      payments: ["現金","信用卡","行動支付"]
    };

    let selectedCat = db.categories[0];
    let selectedPay = db.payments[0];
    let calcExpr = "";

    function getTodayString() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function updateToToday() {
      const today = getTodayString();
      const dateInput = document.getElementById("dateInput");
      if (dateInput && dateInput.value !== today) dateInput.value = today;
    }

    function saveDB() { localStorage.setItem(LS_KEY, JSON.stringify(db)); updateStats(); }

    function updateStats() {
      const ym = document.getElementById("monthPicker")?.value || getTodayString().slice(0, 7);
      const monthly = db.transactions.filter(t => t.date.startsWith(ym));
      const total = monthly.reduce((s, t) => s + t.amount, 0);
      document.querySelectorAll(".dashTotal").forEach(el => el.textContent = `$ ${total.toLocaleString()}`);
      
      const catStats = {};
      monthly.forEach(t => { catStats[t.category] = (catStats[t.category] || 0) + t.amount; });
      const sorted = Object.entries(catStats).sort((a,b) => b[1] - a[1]);
      const top3 = document.getElementById("dashTopThree");
      if(top3) top3.innerHTML = sorted.slice(0, 3).map(([c, a], i) => `<div class="top-rank-item"><span>${i+1}. ${c}</span><span>$${a.toLocaleString()}</span></div>`).join('');
    }

    // 【核心邏輯：每日自動計算與溯及既往】
    function renderHistory() {
      const ym = document.getElementById("monthPicker").value;
      const filtered = db.transactions.filter(t => t.date.startsWith(ym)).sort((a,b) => b.date.localeCompare(a.date));
      
      if (!filtered.length) {
        document.getElementById("historyList").innerHTML = '<div style="text-align:center; padding:50px; color:var(--muted)">本月尚無紀錄</div>';
        return;
      }

      // 按日期分組
      const groups = {};
      filtered.forEach(t => {
        if (!groups[t.date]) groups[t.date] = { items: [], total: 0 };
        groups[t.date].items.push(t);
        groups[t.date].total += t.amount;
      });

      // 構建 HTML
      let html = "";
      Object.keys(groups).sort((a,b) => b.localeCompare(a)).forEach(date => {
        const g = groups[date];
        // 每日標題欄：左邊顯示日期，右邊顯示該日總計
        html += `
          <div class="day-group-header">
            <div class="day-date">${date}</div>
            <div class="day-total">日計: $${g.total.toLocaleString()}</div>
          </div>
        `;
        // 該日的所有明細
        g.items.forEach(t => {
          html += `
            <div class="list-item">
              <div style="flex:1">
                <div style="font-size:11px; color:var(--muted)">${t.payment}</div>
                <div style="font-size:15px; font-weight:600">${t.category}</div>
                <div style="font-size:12px; color:var(--muted)">${t.note || ''}</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:18px; font-weight:800; color:var(--accent)">$${t.amount.toLocaleString()}</div>
                <button onclick="deleteTx(${t.id})" style="color:var(--danger); background:none; border:none; font-size:12px; margin-top:5px">刪除</button>
              </div>
            </div>
          `;
        });
      });
      document.getElementById("historyList").innerHTML = html;
    }

    function setupNav() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.onclick = () => {
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          const p = item.dataset.page;
          document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
          document.getElementById('page-' + p).classList.add('active');
          updateToToday();
          if(p === 'list') renderHistory();
          if(p === 'settings') renderSettings();
        };
      });
    }

    function renderPills() {
      document.getElementById("categoryPills").innerHTML = db.categories.map(c => `<div class="pill ${c===selectedCat?'active':''}" onclick="selectedCat='${c}';renderPills()">${c}</div>`).join('');
      document.getElementById("paymentPills").innerHTML = db.payments.map(p => `<div class="pill ${p===selectedPay?'active':''}" onclick="selectedPay='${p}';renderPills()">${p}</div>`).join('');
    }

    function setupCalc() {
      const keys = ['C','BK','7','8','9','/','4','5','6','*','1','2','3','-','0','.','+','='];
      document.getElementById("calcGrid").innerHTML = keys.map(k => `<button class="key ${['C','BK'].includes(k)?'danger':['/','*','-','+','='].includes(k)?'op':''}" data-key="${k}">${k==='BK'?'⌫':k}</button>`).join('');
      document.querySelectorAll('.key').forEach(btn => {
        btn.onclick = () => {
          const k = btn.dataset.key;
          if(k === 'C') calcExpr = "";
          else if(k === 'BK') calcExpr = calcExpr.slice(0, -1);
          else if(k === '=') { try { calcExpr = String(eval(calcExpr)); } catch { alert("算式錯誤"); } }
          else { calcExpr += k; }
          document.getElementById("calcExpr").textContent = calcExpr;
          try { 
            const res = eval(calcExpr) || 0; 
            document.getElementById("calcResult").textContent = Math.round(res).toLocaleString();
            document.getElementById("amountInput").value = Math.round(res);
          } catch { }
        };
      });
    }

    document.getElementById("saveBtn").onclick = () => {
      const amt = parseFloat(document.getElementById("amountInput").value);
      if(!amt) return alert("請輸入金額");
      db.transactions.push({ id: Date.now(), date: document.getElementById("dateInput").value, category: selectedCat, payment: selectedPay, amount: amt, note: document.getElementById("noteInput").value });
      saveDB();
      alert("已儲存");
      calcExpr = ""; document.getElementById("calcExpr").textContent = ""; document.getElementById("calcResult").textContent = "0";
    };

    window.deleteTx = (id) => { if(confirm("確定刪除？")) { db.transactions = db.transactions.filter(t => t.id !== id); saveDB(); renderHistory(); } };

    function renderSettings() {
      document.getElementById("catSetList").innerHTML = db.categories.map((c, idx) => `<div class="set-item"><span>${c}</span><button onclick="db.categories.splice(${idx},1);saveDB();renderSettings()">✕</button></div>`).join('');
      document.getElementById("paySetList").innerHTML = db.payments.map((p, idx) => `<div class="set-item"><span>${p}</span><button onclick="db.payments.splice(${idx},1);saveDB();renderSettings()">✕</button></div>`).join('');
    }

    function init() {
      updateToToday();
      const m = document.getElementById("monthPicker"); m.value = getTodayString().slice(0, 7);
      m.onchange = () => { renderHistory(); updateStats(); };
      renderPills(); setupCalc(); setupNav(); updateStats();
    }
    
    window.exportToExcel = () => {
      const ym = document.getElementById("monthPicker").value;
      const filtered = db.transactions.filter(t => t.date.startsWith(ym));
      XLSX.writeFile(XLSX.utils.book_new().appendChild(XLSX.utils.json_to_sheet(filtered), "History"), `記帳_${ym}.xlsx`);
    };

    init();
  </script>
</body>
</html>
