<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="è¡Œå‹•è¨˜å¸³">
  <meta name="apple-mobile-web-app-title" content="è¡Œå‹•è¨˜å¸³">
  <meta name="theme-color" content="#000000">
  <link rel="icon" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/2953/2953423.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2953/2953423.png">
  <link rel="manifest" href="manifest.json">
  <title>è¡Œå‹•åˆ†æè¨˜å¸³æœ¬</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#000000; --card:#161b22; --text:#ffffff; --muted:#8b949e; --line:#30363d; --accent:#58a6ff; --danger:#f85149; --nav-height: 65px; --today-color: #aff5b4; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin:0; font-family: -apple-system, system-ui, sans-serif; background:var(--bg); color:var(--text); padding-bottom: calc(var(--nav-height) + 20px); }
    .container { padding: 12px; max-width: 600px; margin: 0 auto; }
    .header { padding: 20px 16px 5px; font-size: 20px; font-weight: 800; color: var(--accent); }
    .stat-card { background: linear-gradient(145deg, #1c2128, #161b22); border: 1px solid var(--line); border-radius: 20px; padding: 18px; margin-bottom: 12px; }
    .today-card { background: linear-gradient(145deg, #1a2a1a, #161b22); border: 1px solid #238636; border-radius: 20px; padding: 15px; margin-bottom: 12px; }
    .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-main-num { font-size: 28px; font-weight: 900; color: var(--text); margin: 5px 0; }
    .top-rank-item { display: flex; justify-content: space-between; font-size: 13px; margin-top: 8px; padding: 4px 0; border-bottom: 1px solid #21262d; }
    .ratio-bar-container { margin-bottom: 12px; }
    .ratio-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .ratio-bg { background: #21262d; height: 6px; border-radius: 3px; overflow: hidden; }
    .ratio-fill { background: var(--accent); height: 100%; transition: width 0.3s ease; }
    .page { display: none; animation: fadeIn 0.2s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 20px; padding: 16px; margin-bottom: 12px; }
    label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--line); background: #0d1117; color: #fff; font-size: 16px; }
    .calc-box { background: #000; border-radius: 16px; padding: 10px; border: 1px solid var(--line); }
    .calc-display { text-align: right; padding: 8px; margin-bottom: 8px; border-bottom: 1px solid var(--line); }
    #calcExpr { font-size: 13px; color: var(--muted); min-height: 18px; font-family: monospace; }
    #calcResult { font-size: 28px; font-weight: 900; margin-top: 2px; }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .key { padding: 16px 0; border-radius: 12px; border: none; background: #21262d; color: #fff; font-size: 18px; font-weight: 600; cursor: pointer; }
    .key.op { color: var(--accent); }
    .key.danger { color: var(--danger); }
    .key.confirm { background: var(--accent); color: #000; grid-column: span 2; }
    .pill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .pill { padding: 10px 4px; border-radius: 10px; border: 1px solid var(--line); background: #0d1117; color: var(--text); font-size: 12px; cursor: pointer; text-align: center; }
    .pill.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: rgba(22, 27, 34, 0.96); backdrop-filter: blur(12px); border-top: 1px solid var(--line); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--muted); text-decoration: none; font-size: 11px; gap: 4px; flex: 1; cursor: pointer; }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 20px; }
    .btn-save { width: 100%; padding: 18px; border-radius: 16px; border: none; background: var(--accent); color: #000; font-size: 18px; font-weight: 800; cursor: pointer; margin-top: 15px; }
    .list-item { background: var(--card); border-bottom: 1px solid var(--line); padding: 14px; display: flex; justify-content: space-between; align-items: center; }
    .set-item { display: flex; align-items: center; background: #0d1117; padding: 14px; border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--line); touch-action: none; }
    .drag-handle { cursor: grab; padding-right: 18px; color: var(--muted); font-size: 22px; user-select: none; }
    .ios-tip { font-size: 11px; color: var(--muted); margin-top: 20px; padding: 10px; border: 1px dashed var(--line); border-radius: 10px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="header">è¡Œå‹•åˆ†æè¨˜å¸³æœ¬</div>
  <div class="container">
    <div id="page-add" class="page active">
      <div class="stat-card"><div class="stat-label">æœ¬æœˆç¸½æ”¯å‡º</div><div class="stat-main-num dashTotal">$ 0</div><div id="dashTopThree"></div></div>
      <div class="card">
        <label>æ—¥æœŸ (æ¯æ—¥è‡ªå‹•æ›´æ–°)</label><input id="dateInput" type="date" style="margin-bottom:15px;" />
        <label>åˆ†é¡</label><div id="categoryPills" class="pill-grid"></div>
        <label>ä»˜æ¬¾æ–¹å¼</label><div id="paymentPills" class="pill-grid"></div>
        <label>å‚™è¨»</label><textarea id="noteInput" rows="2" placeholder="å‚™è¨»å…§å®¹..."></textarea>
      </div>
      <div class="card">
        <label>é‡‘é¡ç¢ºèª</label><input id="amountInput" type="text" readonly placeholder="0" style="color:var(--accent); font-weight:800; text-align:right; margin-bottom:15px;" />
        <div class="calc-box"><div class="calc-display"><div id="calcExpr"></div><div id="calcResult">0</div></div><div class="calc-grid" id="calcGrid"></div></div>
        <button class="btn-save" id="saveBtn">å„²å­˜ç´€éŒ„</button>
      </div>
    </div>

    <div id="page-list" class="page">
      <div class="today-card">
        <div class="stat-label" style="color:#aff5b4;">ä»Šæ—¥ç¸½æ”¯å‡º (è‡ªå‹•æ›æ—¥)</div>
        <div class="stat-main-num" id="todayTotal" style="color:#aff5b4;">$ 0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-label">æœ¬æœˆç¸½æ”¯å‡ºåˆ†æ</div>
        <div class="stat-main-num dashTotal">$ 0</div>
        <div id="ratioBars" style="margin-top:15px; border-top:1px solid #30363d; padding-top:15px;"></div>
      </div>
      
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <input id="monthPicker" type="month" style="width:auto; padding:8px;" />
        <button onclick="exportToExcel()" style="color:var(--accent); background:none; border:none; font-weight:bold;">åŒ¯å‡º EXCEL</button>
      </div>
      <div id="historyList"></div>
    </div>

    <div id="page-settings" class="page">
      <div class="card">
        <h2>åˆ†é¡ç®¡ç†</h2>
        <div style="display:flex; gap:8px; margin-bottom:12px;"><input id="newCatInput" type="text" placeholder="æ–°åˆ†é¡åç¨±" /><button onclick="addItem('categories')" style="background:var(--accent); border:none; padding:0 15px; border-radius:12px; color:#000; font-weight:bold;">ï¼‹</button></div>
        <div id="catSetList"></div>
      </div>
      <div class="card">
        <h2>ä»˜æ¬¾æ–¹å¼</h2>
        <div style="display:flex; gap:8px; margin-bottom:12px;"><input id="newPayInput" type="text" placeholder="æ–°ä»˜æ¬¾åç¨±" /><button onclick="addItem('payments')" style="background:var(--accent); border:none; padding:0 15px; border-radius:12px; color:#000; font-weight:bold;">ï¼‹</button></div>
        <div id="paySetList"></div>
      </div>
      <div class="ios-tip">ğŸ’¡ <b>iPhone ä½¿ç”¨å°æ’‡æ­¥ï¼š</b><br>è«‹ä½¿ç”¨ <b>Safari</b> é–‹å•Ÿç¶²å€ä¸¦ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚</div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" data-page="add"><div class="nav-icon">ï¼‹</div><div>è¨˜å¸³</div></div>
    <div class="nav-item" data-page="list"><div class="nav-icon">â˜°</div><div>æ˜ç´°</div></div>
    <div class="nav-item" data-page="settings"><div class="nav-icon">âš™</div><div>è¨­å®š</div></div>
  </div>

  <script>
    const LS_KEY = "mobile_expense_v1";
    let db = JSON.parse(localStorage.getItem(LS_KEY)) || { transactions: [], categories: ["æ—©é¤","åˆé¤","æ™šé¤","äº¤é€š","è³¼ç‰©","é†«ç™‚","å…¶ä»–"], payments: ["ç¾é‡‘","ä¿¡ç”¨å¡","è¡Œå‹•æ”¯ä»˜"] };
    let selectedCat = db.categories[0]; let selectedPay = db.payments[0]; let calcExpr = "";

    function getTodayString() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function updateToToday() {
      const today = getTodayString();
      const dateInput = document.getElementById("dateInput");
      if (dateInput && dateInput.value !== today) {
        dateInput.value = today;
        updateStats(); // æ—¥æœŸè®Šæ›´æ™‚ç«‹åˆ»é‡æ–°è¨ˆç®—
      }
    }

    function saveDB() { localStorage.setItem(LS_KEY, JSON.stringify(db)); updateStats(); }

    function updateStats() {
      const todayStr = getTodayString();
      const ym = document.getElementById("monthPicker")?.value || todayStr.slice(0, 7);
      
      // è¨ˆç®—æœ¬æœˆ
      const monthly = db.transactions.filter(t => t.date.startsWith(ym));
      const totalMonthly = monthly.reduce((s, t) => s + t.amount, 0);
      document.querySelectorAll(".dashTotal").forEach(el => el.textContent = `$ ${totalMonthly.toLocaleString()}`);

      // ã€æ ¸å¿ƒåŠŸèƒ½ï¼šè¨ˆç®—ä»Šæ—¥ç¸½è¨ˆã€‘
      const daily = db.transactions.filter(t => t.date === todayStr);
      const totalDaily = daily.reduce((s, t) => s + t.amount, 0);
      const todayEl = document.getElementById("todayTotal");
      if(todayEl) todayEl.textContent = `$ ${totalDaily.toLocaleString()}`;

      // æ’è¡Œæ¦œèˆ‡æ¯”ä¾‹æ¢
      const catStats = {}; monthly.forEach(t => { catStats[t.category] = (catStats[t.category] || 0) + t.amount; });
      const sorted = Object.entries(catStats).sort((a,b) => b[1] - a[1]);
      const top3El = document.getElementById("dashTopThree");
      if(top3El) top3El.innerHTML = sorted.slice(0, 3).map(([c, a], i) => `<div class="top-rank-item"><span style="color:var(--muted)">${i+1}. ${c}</span><span style="color:var(--accent); font-weight:600">$${a.toLocaleString()}</span></div>`).join('') || '<div style="font-size:12px; color:var(--muted); margin-top:10px;">ç›®å‰ç„¡æ•¸æ“š</div>';
      
      const ratioBars = document.getElementById("ratioBars");
      if(ratioBars) ratioBars.innerHTML = sorted.map(([c, a]) => { const r = totalMonthly > 0 ? ((a/totalMonthly)*100).toFixed(1) : 0; return `<div class="ratio-bar-container"><div class="ratio-header"><span>${c}</span><span>$${a.toLocaleString()} (${r}%)</span></div><div class="ratio-bg"><div class="ratio-fill" style="width:${r}%"></div></div></div>`; }).join('') || '<div style="font-size:12px; color:var(--muted); text-align:center;">ç›®å‰ç„¡æ•¸æ“š</div>';
    }

    function setupNav() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.onclick = () => {
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          const p = item.dataset.page;
          document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
          document.getElementById('page-' + p).classList.add('active');
          updateToToday();
          if(p === 'list') { renderHistory(); updateStats(); }
          if(p === 'settings') renderSettings();
        };
      });
    }

    function renderPills() {
      document.getElementById("categoryPills").innerHTML = db.categories.map(c => `<div class="pill ${c===selectedCat?'active':''}" onclick="selectedCat='${c}';renderPills()">${c}</div>`).join('');
      document.getElementById("paymentPills").innerHTML = db.payments.map(p => `<div class="pill ${p===selectedPay?'active':''}" onclick="selectedPay='${p}';renderPills()">${p}</div>`).join('');
    }

    function setupCalc() {
      const keys = ['C','BK','(',')','7','8','9','/','4','5','6','*','1','2','3','-','0','.','+','='];
      document.getElementById("calcGrid").innerHTML = keys.map(k => {
        let cls = "key"; if(['C','BK'].includes(k)) cls += " danger"; if(['/','*','-','+','(',')'].includes(k)) cls += " op"; if(k === '=') cls += " confirm";
        return `<button class="${cls}" data-key="${k}">${k==='BK'?'âŒ«':k==='*'?'Ã—':k==='/'?'Ã·':k}</button>`;
      }).join('');
      document.querySelectorAll('.key').forEach(btn => {
        btn.onclick = () => {
          const k = btn.dataset.key;
          if(k === 'C') calcExpr = ""; else if(k === 'BK') calcExpr = calcExpr.slice(0, -1);
          else if(k === '=') { try { calcExpr = String(eval(calcExpr.replace(/Ã—/g, '*').replace(/Ã·/g, '/'))); } catch { alert("ç®—å¼éŒ¯èª¤"); } }
          else { calcExpr += k; }
          document.getElementById("calcExpr").textContent = calcExpr;
          try { const res = eval(calcExpr.replace(/Ã—/g, '*').replace(/Ã·/g, '/')) || 0; const f = Math.round(res * 100) / 100; document.getElementById("calcResult").textContent = f.toLocaleString(); document.getElementById("amountInput").value = f; } catch { document.getElementById("calcResult").textContent = "â€”"; }
        };
      });
    }

    document.getElementById("saveBtn").onclick = () => {
      const amt = parseFloat(document.getElementById("amountInput").value);
      if(!amt || amt <= 0) return alert("è«‹è¼¸å…¥é‡‘é¡");
      db.transactions.push({ id: Date.now(), date: document.getElementById("dateInput").value, category: selectedCat, payment: selectedPay, amount: amt, note: document.getElementById("noteInput").value });
      saveDB();
      const b = document.getElementById("saveBtn"); b.textContent = "âœ“ å·²å„²å­˜"; b.style.background = "#3fb950";
      setTimeout(() => { b.textContent = "å„²å­˜ç´€éŒ„"; b.style.background = "var(--accent)"; }, 1000);
      calcExpr = ""; document.getElementById("calcResult").textContent = "0"; document.getElementById("amountInput").value = "";
    };

    function renderHistory() {
      const ym = document.getElementById("monthPicker").value;
      const filtered = db.transactions.filter(t => t.date.startsWith(ym)).sort((a,b)=>b.date.localeCompare(a.date));
      document.getElementById("historyList").innerHTML = filtered.length ? filtered.map(t => `<div class="list-item"><div style="flex:1"><div style="font-size:11px; color:var(--muted)">${t.date} Â· ${t.payment}</div><div style="font-size:15px; font-weight:600">${t.category}</div><div style="font-size:12px; color:var(--muted)">${t.note||''}</div></div><div style="text-align:right"><div style="font-size:18px; font-weight:800; color:var(--accent)">$${t.amount.toLocaleString()}</div><button onclick="deleteTx(${t.id})" style="color:var(--danger); background:none; border:none; font-size:12px; font-weight:600; margin-top:5px">åˆªé™¤</button></div></div>`).join('') : '<div style="text-align:center; padding:50px; color:var(--muted)">æœ¬æœˆå°šç„¡ç´€éŒ„</div>';
    }

    window.deleteTx = (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.transactions = db.transactions.filter(t => t.id !== id); saveDB(); renderHistory(); updateStats(); } };

    function renderSettings() { renderDragList('catSetList', 'categories'); renderDragList('paySetList', 'payments'); }

    function renderDragList(containerId, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = db[type].map((item, idx) => `<div class="set-item" data-index="${idx}" data-type="${type}"><div class="drag-handle">â‰¡</div><span style="flex:1; font-weight:500;">${item}</span><button onclick="delItem('${type}', ${idx})" style="color:var(--danger); background:none; border:none; font-size:18px;">âœ•</button></div>`).join('');
      const items = container.querySelectorAll('.set-item');
      items.forEach(item => {
        let startY; const handle = item.querySelector('.drag-handle');
        handle.ontouchstart = (e) => { startY = e.touches[0].clientY; item.classList.add('dragging'); };
        handle.ontouchmove = (e) => { e.preventDefault(); const currentY = e.touches[0].clientY; const afterElement = getDragAfterElement(container, currentY); const dragging = document.querySelector('.dragging'); if (afterElement == null) container.appendChild(dragging); else container.insertBefore(dragging, afterElement); };
        handle.ontouchend = () => { item.classList.remove('dragging'); const newList = Array.from(container.querySelectorAll('span')).map(s => s.textContent); db[type] = newList; saveDB(); renderPills(); };
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.set-item:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    window.addItem = (type) => { const input = document.getElementById(type === 'categories' ? 'newCatInput' : 'newPayInput'); if(input.value.trim()) { db[type].push(input.value.trim()); input.value = ""; saveDB(); renderSettings(); renderPills(); } };
    window.delItem = (type, idx) => { if(db[type].length > 1) { db[type].splice(idx, 1); saveDB(); renderSettings(); renderPills(); } };

    function init() {
      updateToToday();
      const m = document.getElementById("monthPicker"); m.value = getTodayString().slice(0, 7);
      m.onchange = () => { renderHistory(); updateStats(); };
      renderPills(); setupCalc(); setupNav(); updateStats();
      setInterval(updateToToday, 30000); 
      window.addEventListener('focus', () => { updateToToday(); updateStats(); });
    }

    window.exportToExcel = () => {
      const ym = document.getElementById("monthPicker").value;
      const filtered = db.transactions.filter(t => t.date.startsWith(ym));
      XLSX.writeFile(XLSX.utils.book_new().appendChild(XLSX.utils.json_to_sheet(filtered), "History"), `è¨˜å¸³_${ym}.xlsx`);
    };
    init();
  </script>
</body>
</html>


